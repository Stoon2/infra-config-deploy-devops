FROM ubuntu:latest
USER root
# install ssh server
RUN apt update && apt install  openssh-server sudo -y

# add jenkins user with shell and home dir, add to sudoers group
RUN useradd -rm -d /home/jenkins -s /bin/bash -g root -G sudo -u 1000 jenkins

# configure sudoe for jenkins
RUN echo 'jenkins ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

# install open-jdk to prepare container as slave node for jenkins
RUN apt install default-jdk -y

# install git to allow jenkins to pull repos
RUN sudo apt install git -y

# copy rsa key to home dir, configure and register ssh key
COPY jenkins-slave.pub .
RUN mkdir /home/jenkins/.ssh
RUN touch /home/jenkins/.ssh/authorized_keys
RUN cat jenkins-slave.pub >> /home/jenkins/.ssh/authorized_keys
RUN service ssh start
EXPOSE 22
CMD ["/usr/sbin/sshd","-D"]